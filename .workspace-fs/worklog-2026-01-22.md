### Worklog (2026-01-22)

#### Added dependencies
- `better-auth`
- `drizzle-orm`
- `drizzle-kit` (migration base only; operational procedure not set up yet)
- `@libsql/client` (Turso connection)
- `@vercel/sandbox` (Vercel Sandbox SDK)

#### Added major modules
- **DB connection**: `lib/db.ts` (`DATABASE_URL` / `DATABASE_AUTH_TOKEN`)
- **Auth**: `lib/auth.ts`, `lib/auth-client.ts`, `lib/auth-utils.ts`
  - Next.js handler: `app/api/auth/[...all]/route.ts`
- **App schema (temporary)**: `lib/schema/*`
  - `agents`, `conversations`, `messages`, `sandbox_instances`
- **Sandbox management (minimal)**: `lib/sandbox/manager.ts`

#### Added APIs (Route Handlers)
- **Agents**
  - `GET /api/agents`
  - `POST /api/agents`
  - `GET /api/agents/:id`
- **Conversations**
  - `GET /api/conversations`
  - `POST /api/conversations` (start new conversation = create sandbox + save sandboxId in DB)
  - `GET /api/conversations/:id`
  - `GET /api/conversations/:id/messages`
  - `POST /api/conversations/:id/messages` (execute input via `bash -lc` in sandbox -> save to messages)
  - `POST /api/conversations/:id/archive` (stop sandbox + archive)

#### UI (minimal)
- Landing: `app/page.tsx` (logged out -> sign-in/up, logged in -> `/app`)
- Auth: `app/(auth)/sign-in`, `app/(auth)/sign-up`
- App: `app/(app)/layout.tsx`, `app/(app)/app/page.tsx` (/app)

#### Not done / known gaps
- **DB migrations not set up**
  - BetterAuth table creation (BetterAuth CLI, etc.)
  - App table creation (Drizzle Kit, etc.)
- **No sandbox artifact persistence** (by design; archived is chat history only)
- **Input = shell execution** is MVP only; future tooling/limits are required

#### Added (AI SDK Chat, 2026-01-22)
- **Dependencies**: `ai`, `@ai-sdk/react`, `@ai-sdk/openai-compatible`, `bash-tool`, `zod`
- **API**: `POST /api/chat` streams UI messages via `createAgentUIStreamResponse`
- **Agent runtime**: `lib/agent/runtime-agent.ts` builds `ToolLoopAgent` with `bash-tool` and AI Gateway defaults
- **Message persistence**: store full `UIMessage` JSON in `messages.metadata` for reconstruction
- **UI**: `/app` chat now uses `useChat` + `DefaultChatTransport`

#### Addendum (2026-01-22)
- Standardized DB env var names from `TURSO_*` to `DATABASE_URL` / `DATABASE_AUTH_TOKEN` (updated implementation, README, and `.workspace-fs`)
- Added optional sign-up email domain allowlist via `SIGNUP_ALLOWED_EMAIL_DOMAINS` (exact-match only)
- Added one-off cleanup script: `bun scripts/clear-users.ts --yes` (clears auth users; add `--auth-only` to avoid clearing app tables)

#### Addendum (2026-01-22)
- Added sandbox file download endpoint: `GET /api/conversations/:id/sandbox/files?path=...`
- UI: writeFile tool path is clickable and downloads from the sandbox

